{% extends 'base.html' %}
{% load static %}

{% block title %}Exam Results - {{ exam.name }}{% endblock %}

{% block extra_css %}
<!-- Data Table CSS -->
<link rel="stylesheet" href="{% static 'css/jquery.dataTables.min.css' %}">
<style>
    .grade-A { background-color: #28a745; color: white; }
    .grade-B { background-color: #17a2b8; color: white; }
    .grade-C { background-color: #ffc107; color: black; }
    .grade-D { background-color: #fd7e14; color: white; }
    .grade-E { background-color: #dc3545; color: white; }
    .grade-F { background-color: #6c757d; color: white; }
</style>
{% endblock %}

{% block content %}
<div id="wrapper" class="wrapper bg-ash">
    {% include 'includes/header.html' %}

    <div class="dashboard-page-one">
        {% include 'includes/sidebar.html' %}
        <div class="dashboard-content-one">
            <div class="breadcrumbs-area">
                <h3>Exam Results</h3>
                <ul>
                    <li><a href="{% url 'teacher_dashboard' %}">Home</a></li>
                    <li><a href="{% url 'teacher_exam_management' %}">Exam Management</a></li>
                    <li>{{ exam.name }}</li>
                </ul>
            </div>

            <!-- Exam Summary -->
            <div class="row gutters-20">
                <div class="col-xl-3 col-sm-6">
                    <div class="dashboard-summery-one mg-b-20">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <div class="item-icon bg-light-green">
                                    <i class="fas fa-users text-green"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="item-content">
                                    <div class="item-title">Total Students</div>
                                    <div class="item-number"><span>{{ total_students }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="dashboard-summery-one mg-b-20">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <div class="item-icon bg-light-blue">
                                    <i class="fas fa-chart-bar text-blue"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="item-content">
                                    <div class="item-title">Average Marks</div>
                                    <div class="item-number"><span>{{ average_marks|floatformat:2 }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="dashboard-summery-one mg-b-20">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <div class="item-icon bg-light-yellow">
                                    <i class="fas fa-trophy text-yellow"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="item-content">
                                    <div class="item-title">Highest Marks</div>
                                    <div class="item-number"><span>{{ highest_marks|floatformat:2 }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-sm-6">
                    <div class="dashboard-summery-one mg-b-20">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <div class="item-icon bg-light-red">
                                    <i class="fas fa-chart-line text-red"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="item-content">
                                    <div class="item-title">Lowest Marks</div>
                                    <div class="item-number"><span>{{ lowest_marks|floatformat:2 }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0">{{ exam.name }} - Results</h4>
                                    <p class="mb-0 text-muted">{{ exam.subject.name }} | {{ exam.class_level.name }}</p>
                                </div>
                                <div class="btn-group">
                                    <a href="{% url 'enter_marks' exam.id %}" class="btn btn-warning">
                                        <i class="fas fa-edit mr-2"></i>Edit Marks
                                    </a>
                                    <a href="{% url 'exam_analysis' exam.id %}" class="btn btn-info">
                                        <i class="fas fa-chart-bar mr-2"></i>View Analysis
                                    </a>
                                    <div class="dropdown ml-2">
                                        <button class="btn btn-success dropdown-toggle" type="button" data-toggle="dropdown">
                                            <i class="fas fa-download mr-2"></i>Export
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="{% url 'export_results_excel' exam.id %}">
                                                <i class="fas fa-file-excel text-success mr-2"></i>Export to Excel
                                            </a>
                                            <a class="dropdown-item" href="{% url 'export_results_pdf' exam.id %}">
                                                <i class="fas fa-file-pdf text-danger mr-2"></i>Export to PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="card height-auto">
                <div class="card-body">
                    <div class="heading-layout1">
                        <div class="item-title">
                            <h3>Student Results</h3>
                        </div>
                        <div class="dropdown">
                            <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown">...</a>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" href="{% url 'enter_marks' exam.id %}">
                                    <i class="fas fa-edit"></i> Edit Marks
                                </a>
                                <a class="dropdown-item" href="{% url 'bulk_upload_results' exam.id %}">
                                    <i class="fas fa-upload"></i> Bulk Upload
                                </a>
                            </div>
                        </div>
                    </div>

                    {% if results %}
                    <div class="table-responsive">
                        <table id="resultsTable" class="table display text-nowrap">
                            <thead>
                                <tr>
                                    <th>Position</th>
                                    <th>Student</th>
                                    <th>Roll No</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Remarks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td>
                                        <span class="badge badge-primary">{{ result.position }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if result.student.photo %}
                                            <img src="{{ result.student.photo.url }}" alt="{{ result.student.full_name }}" 
                                                 class="rounded-circle mr-2" width="40" height="40">
                                            {% else %}
                                            <div class="avatar bg-primary text-white rounded-circle mr-2" style="width: 40px; height: 40px; line-height: 40px; text-align: center;">
                                                {{ result.student.first_name|first }}{{ result.student.last_name|first }}
                                            </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ result.student.full_name }}</h6>
                                                <small class="text-muted">{{ result.student.student_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ result.student.roll_number }}</td>
                                    <td>
                                        <span class="font-weight-bold text-{% if result.marks_obtained >= 80 %}success{% elif result.marks_obtained >= 50 %}warning{% else %}danger{% endif %}">
                                            {{ result.marks_obtained }}/{{ exam.total_marks }}
                                        </span>
                                    </td>
                                    <td>
                                        {% widthratio result.marks_obtained exam.total_marks 100 %}%
                                    </td>
                                    <td>
                                        <span class="badge grade-{{ result.grade }}">{{ result.grade }}</span>
                                    </td>
                                    <td>
                                        <small>{{ result.remarks|default:"-" }}</small>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                <span class="flaticon-more-button-of-three-dots"></span>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <a class="dropdown-item" href="#">
                                                    <i class="fas fa-edit text-blue"></i> Edit Result
                                                </a>
                                                <a class="dropdown-item" href="#">
                                                    <i class="fas fa-chart-line text-purple"></i> Performance
                                                </a>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item text-danger" href="#">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Results Available</h5>
                        <p class="text-muted">No marks have been entered for this exam yet.</p>
                        <a href="{% url 'enter_marks' exam.id %}" class="btn btn-primary">
                            <i class="fas fa-edit mr-2"></i>Enter Marks
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Grade Distribution -->
            {% if grade_distribution %}
            <div class="row mt-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Grade Distribution</h4>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Grade</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                            <th>Range</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dist in grade_distribution %}
                                        <tr>
                                            <td>
                                                <span class="badge grade-{{ dist.grade }}">{{ dist.grade }}</span>
                                            </td>
                                            <td>{{ dist.count }}</td>
                                            <td>{% widthratio dist.count total_students 100 %}%</td>
                                            <td>
                                                {% if dist.grade == 'A' %}80-100%
                                                {% elif dist.grade == 'B' %}70-79%
                                                {% elif dist.grade == 'C' %}60-69%
                                                {% elif dist.grade == 'D' %}50-59%
                                                {% elif dist.grade == 'E' %}40-49%
                                                {% else %}0-39%{% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Data Table Js -->
<script src="{% static 'js/jquery.dataTables.min.js' %}"></script>
<script>
    $(document).ready(function() {
        $('#resultsTable').DataTable({
            "pageLength": 25,
            "responsive": true,
            "order": [[0, 'asc']]
        });
    });
</script>
{% endblock %}